<script>
  // 地図初期化
  const map = L.map('map').setView([34.9719, 138.3889], 17);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // 位置検索コントロールを追加
  L.Control.geocoder({
    defaultMarkGeocode: true, // 検索結果にマーカーを追加
    placeholder: "検索したい住所や施設名を入力"
  }).addTo(map);

  // ここにMarkerCluster + CSV読み込みのコードを追加
  const markers = L.markerClusterGroup();

  Papa.parse("https://raw.githubusercontent.com/horiikekouhei/shizuokamap/main/public/data.csv", {
    download: true,
    header: true,
    complete: function(results) {
      results.data.forEach(row => {
        if (row["緯度"] && row["経度"]) {
          const lat = parseFloat(row["緯度"]);
          const lng = parseFloat(row["経度"]);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]);
            marker.bindPopup(
              `<b>${row["情報名"]}</b><br>受信日: ${row["受信日"]}<br>状態: ${row["状態"]}`
            );
            markers.addLayer(marker);
          }
        }
      });
      map.addLayer(markers);
    }
  });
</script>
